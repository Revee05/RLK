________________________________________
Dokumentasi Teknis: Sistem Otomatisasi & Penentuan Pemenang Lelang
Dokumen ini menjelaskan cara kerja sistem dalam menentukan pemenang lelang secara otomatis saat waktu lelang berakhir, termasuk alur backend dan cara frontend menampilkan status “MENANG” atau “KALAH”.
________________________________________
1. Alur Kerja Sistem (Workflow)
1.	User melakukan bid pada sebuah produk.
2.	Cron Job berjalan otomatis (misalnya setiap menit) untuk mengecek produk yang sudah melewati waktu end_date.
3.	Backend menentukan penawar tertinggi.
4.	Database diperbarui:
o	Status produk berubah menjadi Sold.
o	Kolom winner_id diisi dengan ID pemenang.
5.	Frontend menampilkan status berdasarkan apakah user yang login adalah pemenang.
________________________________________
2. Struktur Database
A. Tabel: products
Kolom	Tipe	Keterangan
id	PK	ID Produk
status	INT	1 = Live, 2 = Sold, 3 = Expired
end_date	DATETIME	Waktu akhir lelang
winner_id	INT (nullable)	ID pemenang lelang
B. Tabel: bids
Kolom	Keterangan
product_id	ID Produk
user_id	ID User
price	Nominal tawaran
________________________________________
3. Backend (Laravel)
A. Model
•	App\Product
•	App\Bid
Digunakan untuk berinteraksi dengan database.
________________________________________
B. Console Command – Otak Sistem
File: app/Console/Commands/CloseExpiredAuctions.php
Logika Utama:
1.	Ambil semua produk status = 1 dan end_date < now().
2.	Untuk setiap produk:
o	Cari bid tertinggi dengan orderBy('price','desc').
3.	Jika ada bid:
o	Ubah status → 2 (Sold).
o	Isi winner_id → ID user penawar tertinggi.
4.	Jika tidak ada bid:
o	Ubah status → 3 (Expired).
5.	Simpan perubahan.
________________________________________
C. Scheduler (Cron Job)
File: app/Console/Kernel.php
protected function schedule(Schedule $schedule)
{
    $schedule->command('lelang:close-expired')->everyMinute();
}
________________________________________
4. Frontend (Blade / JavaScript)
A. Response JSON yang Harus Disertakan
Pastikan controller mengirim field berikut:
•	status
•	end_date_iso
•	winner_id
•	is_winner (opsional, boolean)
________________________________________
B. Logika Tampilan (JavaScript)
if (product.status === 2 || isExpired) {

    if (currentUserId && product.winner_id == currentUserId) {
        return "MENANG"; // badge hijau
    } else {
        return "KALAH"; // badge abu-abu
    }

}
________________________________________
5. Cara Menjalankan Manual (Testing)
Untuk mengecek script tanpa menunggu cron job:
php artisan lelang:close-expired
Setelah itu, cek tabel products → kolom winner_id harus terisi.
________________________________________
6. Troubleshooting Checklist
Jika badge MENANG tidak tampil meski user adalah pemenang:
•	Apakah winner_id pada tabel products sudah berisi?
•	Apakah controller mengirim winner_id dalam JSON?
•	Apakah currentUserId di frontend berisi ID user yang login?
•	Apakah tipe data cocok? (String vs Integer — gunakan == atau lakukan konversi)
________________________________________

jangan lupa jalan kan php artisan migrate


Test Hapus Otomatis (Hangus):

Edit manual salah satu data di tabel cart_items (yang tipe lelang).

Ubah kolom expires_at jadi kemarin (waktu lampau).

Jalankan: php artisan cart:cleanup-auction

Cek: Item harusnya hilang dari tabel cart_items, dan di tabel products statusnya jadi 3 (Hangus).
